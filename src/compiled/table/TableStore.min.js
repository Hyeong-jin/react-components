define(function(a){"use strict";var b=a("AppDispatcher"),c=a("lodash"),d=a("moment"),e=a("drc/lib/StoreBase"),f=a("drc/table/TableActions"),g=f.actionTypes,h=function(a,b,d){this.id=a,this.url=b.url,this.cols=b.cols,this.sortColIndex=b.sortColIndex,this.pagination=b.pagination,this.cursor=b.cursor,this.rowClick=b.rowClick,this.data=null,this.filteredData=null,this.displayedData=null,this.dataCount=null,this.dataFormatter=d,this.selectedItems={},this.selectDataProperty=c.result(c.find(this.cols,{dataType:"select"}),"dataProperty")};h.prototype={onDataReceived:function(a){this.data=c.values(a),this.dataFormatter&&(this.data=this.dataFormatter(a)),this.dataCount=this.data.length,c.forEach(this.cols,function(a){"status"===a.dataType&&("number"!=typeof a.onlineLimit||a.onlineLimit<1)&&(a.onlineLimit=15),c.forEach(this.data,function(b){"percent"===a.dataType?b[a.dataProperty]+="%":("time"===a.dataType||"status"===a.dataType)&&("status"===a.dataType&&b[a.dataProperty]&&(b.online=d(b[a.dataProperty]).valueOf()>d(Date.now()).subtract(a.onlineLimit,"minutes").valueOf()),b.timestamp=b[a.dataProperty]?b[a.dataProperty]:null,b[a.dataProperty]=b[a.dataProperty]?d(b[a.dataProperty]).format(a.timeFormat):"--")})},this),"number"==typeof this.sortColIndex&&this.sortData(this.sortColIndex,this.cols[this.sortColIndex].sortDirection)},errorFunction:function(){this.data=null},getData:function(){var a=c.cloneDeep(this.data);return this.dataCount=a.length,this.filterValue&&(a=this.filterData(a)),this.filteredData=a,this.pagination&&(a=this.sliceData(a)),this.displayedData=a,this.displayedData},getDataCount:function(){return this.dataCount},getColDefinitions:function(){return this.cols},getSortColIndex:function(){return this.sortColIndex},getRowClickData:function(){return this.rowClick},getPaginationData:function(){return this.pagination},setFilterValue:function(a){this.filterValue=a,this.pagination&&0!==this.pagination.cursor&&this.resetPagination()},filterData:function(a){var b,d=this.filterValue,e=[];return c.forEach(this.cols,function(f){f.quickFilter&&(b=c.remove(a,function(a){return"string"==typeof a[f.dataProperty]?-1!==a[f.dataProperty].toLowerCase().indexOf(d.toString().toLowerCase()):"number"==typeof a[f.dataProperty]?-1!==a[f.dataProperty].toString().indexOf(d.toString()):void 0}),e=e.concat(b))}),this.dataCount=e.length,e},paginate:function(a){var b=this.pagination.size;this.pagination.cursor+="right"===a?b:-1*b},resetPagination:function(){this.pagination.cursor=0},sliceData:function(a){return a.slice(this.pagination.cursor,this.pagination.cursor+this.pagination.size)},sortData:function(a,b){this.sortColIndex=a,this.cols[a].sortDirection=b;var c,d=this.cols[this.sortColIndex].dataType;c="time"===d||"status"===d?"timestamp":this.cols[this.sortColIndex].dataProperty,this.pagination&&this.resetPagination(),this.data.sort(function(a,e){var f=a[c],g=e[c];return"string"===d&&(f=f.toLowerCase(),g=g.toLowerCase()),("time"===d||"status"===d)&&(f=f?f:0,g=g?g:0),f>g?"ascending"===b?1:-1:g>f?"ascending"===b?-1:1:0}.bind(this))},getSelectedItems:function(){return this.selectedItems},getFilteredData:function(){return this.filteredData},updateBulkSelection:function(a){c.forEach(this.filteredData,function(b){a?delete this.selectedItems[b[this.selectDataProperty]]:this.selectedItems[b[this.selectDataProperty]]=!0},this)},updateRowSelection:function(a){var b=this.displayedData[a][this.selectDataProperty];this.selectedItems[b]?delete this.selectedItems[b]:this.selectedItems[b]=!0}};var i=c.merge({collection:{},componentType:"Table",createInstance:function(a,b,c){this.collection[a]=new h(a,b,c)},destroyInstance:function(a){delete this.collection[a]},getInstance:function(a){return this.collection[a]},getSelectedItems:function(a){return c.keys(this.collection[a].getSelectedItems())},dispatchRegister:function(a){var b=a.action;if(this.shouldHandleAction(b.component))switch(b.actionType){case g.REQUEST_DATA:this.handleRequestDataAction(b);break;case g.TABLE_SORT:this.collection[b.id].sortData(b.data.colIndex,b.data.direction),this.emitChange(b.id);break;case g.FILTER:this.collection[b.id].setFilterValue(b.data.value),this.emitChange(b.id);break;case g.PAGINATE:this.collection[b.id].paginate(b.data.direction),this.emitChange(b.id);break;case g.TOGGLE_BULK_SELECT:this.collection[b.id].updateBulkSelection(b.data.deselect),this.emitChange(b.id);break;case g.TOGGLE_ROW_SELECT:this.collection[b.id].updateRowSelection(b.data.rowIndex),this.emitChange(b.id);break;case g.DESTROY_INSTANCE:this.destroyInstance(b.id)}},Table:h},e);return b.register(c.bind(i.dispatchRegister,i)),i});