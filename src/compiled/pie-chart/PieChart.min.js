define(function(a){"use strict";var b=a("d3"),c=a("drc/mixins/DataMixins"),d=a("jquery"),e=a("lodash"),f=a("drc/pie-chart/PieChartActions"),g=a("drc/pie-chart/PieChartStore"),h=a("react"),i=a("drc/utils/Utils"),j=["#00B0F1","#6DD2F7","#58C99E","#11B275","#53959C","#545F88","#6E4A99","#D35E5E","#E4C000","#F37E1C","#ECECEC","#BC0C0C"],k=h.createClass({displayName:"PieChart",propTypes:{componentId:h.PropTypes.string.isRequired,colors:h.PropTypes.array,definition:h.PropTypes.object.isRequired,filters:h.PropTypes.object,loadingIconClasses:h.PropTypes.oneOfType([h.PropTypes.string,h.PropTypes.array])},mixins:[c.dataRequest,c.destroySelfOnUnmount(f),c.eventSubscription(g)],chart:null,arc:null,extraRadius:0,getInitialState:function(){return this.colors=this.props.colors&&e.isArray(this.props.colors)?this.props.colors:j,{loading:!0,svgID:"pieChart"+this.props.componentId,dataStack:[],selectedRowName:null,width:1,height:1,radius:1,dataError:!1}},createVisualization:function(a){var c=0,d=a.length>5?a.length>8?25:50:75;b.select("#"+this.state.svgID+"-container").selectAll("*").remove();var f=b.layout.pie().padAngle(.03).value(function(a){return a.value}).sort(null),g=this.chart.selectAll("path").data(f(a)).enter(),h=g.append("path");h.style("fill",function(){return this.colors[c++]}.bind(this)).style("cursor",function(a){return e.isArray(a.data.children)&&a.data.children.length?"pointer":void 0}).transition().delay(function(a,b){return b*d}).duration(150).attrTween("d",function(a){var c=b.interpolate(a.startAngle+.1,a.endAngle);return function(b){return a.endAngle=c(b),this.arc(a)}.bind(this)}.bind(this)).each("end",function(){setTimeout(function(){h.on("click",this.drillIn),h.on("mouseover",this.mouseover),h.on("mouseleave",this.mouseout)}.bind(this),400)}.bind(this))},drillIn:function(a){if(a.data.children){var b=this.state.dataStack;b.push({data:a.data.children,label:a.data.name+" - "+a.data.percent+"%"}),this.createVisualization(a.data.children),this.setState({dataStack:b}),d("#item-list-"+this.props.componentId).scrollTop(0)}},drillOut:function(){var a=this.state.dataStack;a.pop(),this.createVisualization(e.last(a).data),this.setState({dataStack:a}),d("#item-list-"+this.props.componentId).scrollTop(0)},mouseover:function(a){this.setState({selectedRowName:a.data.name}),this.chart.selectAll("path").attr("d",this.arc),this.extraRadius=10,this.chart.selectAll("#"+this.state.svgID+" path").filter(function(b){return b.data.name===a.data.name}).transition().duration(100).attr("d",this.arc),this.extraRadius=0},mouseout:function(){var a=this.mouseover;this.setState({selectedRowName:null}),this.chart.selectAll("path").on("mouseover",null),this.chart.selectAll("path").transition().duration(100).attr("d",this.arc).each(function(){b.select(this).on("mouseover",a)})},onDataReceived:function(){var a=g.getData(this.props.componentId);if(!a)return void this.onError();var c=b.select("#"+this.state.svgID),d=Math.min(325,parseInt(c.style("width")))-25,f=.75*d,h=Math.min(d,f)/2-20,i=this.state.dataStack;i.push({data:a,label:null}),this.setState({width:d,height:f,radius:h,dataStack:i,loading:!1}),this.chart=b.select("#"+this.state.svgID+"-container"),this.arc=b.svg.arc().outerRadius(e.bind(function(){return h+this.extraRadius},this)).innerRadius(h-50),this.createVisualization(a)},onError:function(){this.setState({loading:!1,dataError:!0})},requestData:function(){this.setState({loading:!0,dataError:!1}),f.requestData(this.props.componentId,this.props.definition,this.props.filters)},componentDidUpdate:function(){var a=d("tr.selected");if(a&&void 0!==a.prop("rowIndex")){var b=a.prop("rowIndex"),c=0;b>3&&(c=47*(b-b%4)),d("#item-list-"+this.props.componentId).stop().animate({scrollTop:c},150)}},getRowDisplay:function(){var a,b=[],c=e.last(this.state.dataStack);if(!c)return!1;for(c=c.data,a=0;a<c.length;a++){var d=c[a],f={backgroundColor:this.colors[a]},g=this.state.selectedRowName===d.name,j=g?{borderLeft:"solid 6px "+this.colors[a]}:{},k=h.addons.classSet({"table-even":a%2,"table-odd":a%2===0,selected:g});b.push(h.createElement("tr",{key:"table-row-"+i.guid(),className:k},h.createElement("td",null,h.createElement("div",{className:"row-container",style:j},h.createElement("span",{className:"color-legend",style:f}),h.createElement("span",{className:"table-key"},d.name),h.createElement("span",{className:"table-val",title:"Count: "+d.value},d.percent+"%")))))}return b},render:function(){var a,b,c=this.getRowDisplay(),d=e.last(this.state.dataStack);d&&d.label&&(b=h.createElement("span",{className:"breadCrumb",onClick:this.drillOut},h.createElement("i",{className:"ion ion-chevron-left"}),d.label));var f=h.addons.classSet({"data-container":!0,masked:this.state.loading||this.state.dataError,error:this.state.dataError});return d&&!d.data.length&&(a=h.createElement("div",{className:"no-results"},"There were no results that matched the selected range.")),h.createElement("div",{className:"data-component pie-chart"},h.createElement("span",{className:"module-sub-heading"},g.getLabel(this.props.componentId)),h.createElement("div",{className:f},h.createElement("i",{className:i.getLoaderClasses(this.state.loading,this.props.loadingIconClasses)}),h.createElement("div",{className:"pie-chart-data"},b,a,h.createElement("div",{id:this.state.svgID,ref:"chartNode",className:"pie-chart-wrapper"},h.createElement("svg",{height:this.state.height,width:this.state.width},h.createElement("g",{key:this.state.svgID,id:this.state.svgID+"-container",transform:"translate("+this.state.width/2+","+this.state.height/2+")"})))),h.createElement("div",{className:"table-container",id:"item-list-"+this.props.componentId},h.createElement("table",{className:"table-body"},h.createElement("tbody",null,c)))))}});return k});