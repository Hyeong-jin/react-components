define(function(a){"use strict";var b=a("lodash"),c=a("react"),d=a("RequestHandler"),e=a("jquery"),f=c.createClass({displayName:"Search",propTypes:{url:c.PropTypes.string.isRequired,isFullDataResponse:c.PropTypes.bool,minLength:c.PropTypes.number,additionalFilters:c.PropTypes.object,searchFilterName:c.PropTypes.string,placeholder:c.PropTypes.string,onDataReceived:c.PropTypes.func,onSelect:c.PropTypes.func,onInputSubmit:c.PropTypes.func,rowFormatter:c.PropTypes.func},focusedIndex:null,actionOverList:!1,currentFilteredList:[],outstandingRequest:null,listKeyCodeHandlers:{38:"focusPrev",40:"focusNext",27:"clearList",13:"selectItemOnEnter"},cache:{},getDefaultProps:function(){return{isFullDataResponse:!1,minLength:2,placeholder:"Search"}},getInitialState:function(){return{disabled:this.props.isFullDataResponse,itemList:[],shownList:[],inputValue:"",inputFocused:!1}},componentDidMount:function(){this.props.isFullDataResponse&&this.requestFullData(),e(document).mouseup(b.bind(function(a){var b=e(".search-component");b.is(a.target)||0!==b.has(a.target).length||this.hideList()},this))},requestFullData:function(){d.request(this.props.url,this.props.additionalFilters,this.onDataReceived,this.onError,this)},requestDataForTerm:function(a){var b=this.cache[this.getSearchTermCacheKey(a)];if(b)return void this.updateStateForNewData(b);var c=this.props.additionalFilters||{};c[this.props.searchFilterName]=a,this.outstandingRequest&&this.outstandingRequest.abort&&this.outstandingRequest.abort(),this.outstandingRequest=d.request(this.props.url,c,this.onDataReceived,this.onError,this)},onError:function(){this.props.isFullDataResponse&&this.setState({placeholder:"Unable to load list",disabled:!0})},onDataReceived:function(a){return a?(this.props.onDataReceived&&(a=this.props.onDataReceived(a,this.state.inputValue),this.setState({shownList:a})),!this.props.isFullDataResponse&&a.length&&a.sort(this.sortMatchingEntries),this.cache[this.getSearchTermCacheKey(this.state.inputValue)]=a,void this.updateStateForNewData(a)):void this.onError()},updateStateForNewData:function(a){var b={itemList:a,disabled:!1};this.props.isFullDataResponse||(b.shownList=a,this.currentFilteredList=a),this.setState(b)},getListOfMatchesForQuery:function(a){var c=[];return a=a.toLowerCase().split(" ").join(""),b.forEach(this.state.itemList,function(b){var d=b.name.toLowerCase().split(" ").join(""),e=d.indexOf(a);e>-1&&(b.matchIndex=e,c.push(b))}),c.length&&c.sort(this.sortMatchingEntries),c},sortMatchingEntries:function(a,b){var c=a.matchIndex,d=b.matchIndex;return void 0===c&&void 0===d&&(c=a.secondaryMatchIndex,d=b.secondaryMatchIndex),void 0!==d&&void 0===c?1:void 0!==c&&void 0===d?-1:void 0===c&&void 0===d?0:c>d?1:d>c?-1:a.name.length>b.name.length?1:a.name.length<b.name.length?-1:a.name>b.name?1:a.name<b.name?-1:0},getSearchTermCacheKey:function(a){return b.trim(a.toLowerCase().replace(/\s{2,}/g," "))},onChange:function(a){var b=a.target.value;if(this.setState({inputValue:b}),b.length<this.props.minLength)this.currentFilteredList=[],this.setState({shownList:[]});else if(this.props.isFullDataResponse){var c=this.getListOfMatchesForQuery(b);this.currentFilteredList=c,this.setState({shownList:c})}else this.requestDataForTerm(b)},onFocus:function(){this.focusedIndex=null,this.setState({shownList:this.currentFilteredList,inputFocused:!0})},onBlur:function(){this.actionOverList||this.hideList()},onInputKeyPress:function(a){!a.keyCode||40!==a.keyCode&&27!==a.keyCode&&13!==a.keyCode||(a.preventDefault(),40===a.keyCode?this.focusNext():(13===a.keyCode&&this.props.onInputSubmit&&this.props.onInputSubmit(this.state.inputValue),this.currentFilteredList=[],this.setState({shownList:[],inputValue:""})))},onListKeyPress:function(a){var b=this.listKeyCodeHandlers[a.keyCode];b&&this[b]&&(a.preventDefault(),this[b]())},focusNext:function(){var a=this.focusedIndex;this.focusOnItemAtIndex(null===a?0:++a)},focusPrev:function(){var a=this.focusedIndex;null!==a&&(0===a?this.refs.searchInput.getDOMNode().focus():this.focusOnItemAtIndex(--a))},focusOnItemAtIndex:function(a){var b=this.refs.list.getDOMNode().childNodes;a>-1&&a<b.length&&(this.focusedIndex=a,this.actionOverList=!0,b[a].focus())},clearList:function(a){this.actionOverList=!1,this.currentFilteredList=[],this.setState({inputValue:""}),this.hideList(),a||this.refs.searchInput.getDOMNode().focus()},hideList:function(){this.focusedIndex=null,(this.state.shownList.length||this.state.inputFocused)&&this.setState({shownList:[],inputFocused:!1})},selectItemOnEnter:function(){var a=this.refs.list.getDOMNode().childNodes[this.focusedIndex];this.itemSelect({target:a})},itemSelect:function(a){this.props.onSelect&&this.props.onSelect(a,this.state.inputValue),this.clearList(!0)},handleListMouseEnter:function(a){this.actionOverList=!0,a.target.focus(),b.forEach(this.refs.list.getDOMNode().childNodes,b.bind(function(b,c){b===a.target&&(this.focusedIndex=c)},this))},handleListMouseLeave:function(){this.actionOverList=!1},getAutocompleteComponents:function(a){var d=[];return b.forEach(a,b.bind(function(a){d.push(c.createElement("li",{key:a.id,"data-id":a.id,tabIndex:"-1",onMouseEnter:this.handleListMouseEnter},a.name))},this)),d},render:function(){var a=(this.props.rowFormatter||this.getAutocompleteComponents)(this.state.shownList,this.handleListMouseEnter),b=c.addons.classSet({fa:!0,"fa-search":!0,focused:this.state.inputFocused}),d=this.state.itemList?this.props.placeholder:"Loading...";return c.createElement("div",{className:"search-component"},c.createElement("div",{className:"input-group"},c.createElement("i",{className:b}),c.createElement("input",{ref:"searchInput",value:this.state.inputValue,type:"text",autoComplete:"off",placeholder:d,disabled:this.state.disabled,onChange:this.onChange,onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onInputKeyPress}),c.createElement("ul",{ref:"list",className:"autocomplete-list",onClick:this.itemSelect,onMouseLeave:this.handleListMouseLeave,onKeyDown:this.onListKeyPress},a)))}});return f});